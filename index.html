<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Assistant Ubiflow — Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="./style.css" />
  <style>
    /* --- Styles du module Canva --- */
    .canva-toolbar { display:flex; gap:10px; align-items:center; margin:16px 0; flex-wrap:wrap; }
    .canva-toolbar button { 
      appearance:none; border:0; border-radius:10px; padding:10px 14px; 
      font:600 14px/1 Inter, system-ui, sans-serif; cursor:pointer; 
      background:#111; color:#fff; box-shadow:0 2px 8px rgba(0,0,0,.12);
    }

    .canva-overlay { 
      position:fixed; bottom:20px; right:20px; z-index:9999; 
      background:#000; border-radius:14px; overflow:hidden; display:none;
      box-shadow:0 12px 32px rgba(0,0,0,.45);
    }
    .canva-iframe { width:100%; height:100%; border:0; display:block; z-index:1; }

    /* Bandeau de contrôles AU-DESSUS de l'iframe */
    .canva-controls {
      position:absolute; inset:auto 8px 8px 8px; top:8px; display:flex; gap:8px; flex-wrap:wrap;
      background:rgba(17,17,17,.6); backdrop-filter: blur(6px);
      padding:8px; border-radius:10px; z-index:2; pointer-events:auto;
    }
    .canva-controls button {
      appearance:none; border:1px solid rgba(255,255,255,.25); border-radius:8px; 
      background:rgba(255,255,255,.06); color:#fff; font:600 13px/1 Inter, system-ui, sans-serif;
      padding:8px 10px; cursor:pointer;
    }
    .canva-controls button:hover { background:rgba(255,255,255,.14); }
    .canva-controls .danger { border-color: rgba(255,99,99,.4); }

    .canva-close { position:absolute; top:6px; right:6px; 
      background:rgba(255,255,255,.85); border:0; border-radius:8px; 
      padding:4px 8px; cursor:pointer; font-weight:600; z-index:2; }

    /* Optionnel: transition douce */
    .canva-overlay { transition: all .25s ease; }

    /* Responsive guard: si petit écran, ajuste la taille réduite */
    @media (max-width: 480px) {
      .canva-overlay[data-mode="small"] { width: 88vw !important; height: 49.5vw !important; bottom: 6vw; right: 6vw; }
    }
  </style>
</head>
<body>
  <main class="chat-shell">
    <header class="chat-header">
      <div class="title">Assistant Ubiflow</div>
      <div class="actions">
        <button id="new-chat" title="Nouvelle discussion">Nouvelle discussion</button>
      </div>
    </header>

    <section id="chat" class="chat-log" aria-live="polite"></section>

    <form id="composer" class="chat-composer" autocomplete="off">
      <textarea id="input" rows="1" placeholder="Écrivez votre message… (Entrée pour envoyer, Maj+Entrée pour une nouvelle ligne)"></textarea>
      <button id="send" type="submit">Envoyer</button>
    </form>
  </main>

  <!-- Toolbar Canva (état initial : 1 bouton) -->
  <div class="canva-toolbar" id="canva-toolbar">
    <button id="btn-open" title="Afficher le guide Canva">GUIDE CANVA</button>
  </div>

  <!-- Overlay Canva flottant -->
  <div class="canva-overlay" id="canva-overlay" data-mode="small" aria-label="Guide Canva flottant">
    <iframe
      id="canva-iframe"
      class="canva-iframe"
      src="https://www.canva.com/design/DAGx7TmWtA8/7NZvvs6qKpHvqM_jeXgz4g/view?embed"
      allow="autoplay; fullscreen; encrypted-media"
      loading="lazy"
      referrerpolicy="strict-origin-when-cross-origin"
    ></iframe>

    <!-- Contrôles AU-DESSUS de l'iframe -->
    <div class="canva-controls" id="canva-controls" role="toolbar" aria-label="Contrôles d'affichage du guide Canva" style="display:none;">
      <button id="ctrl-small" title="Vue réduite">RÉDUITE</button>
      <button id="ctrl-quarter" title="1/4 de l'écran">1/4 ÉCRAN</button>
      <button id="ctrl-full" title="Plein écran">PLEIN ÉCRAN</button>
      <button id="ctrl-reset" class="danger" title="Revenir à l'état de base">Revenir</button>
    </div>

    <button class="canva-close" id="btn-close" aria-label="Fermer">✕</button>
  </div>

  <script src="./app.js" type="module"></script>
  <script>
    // --- Contrôleur du module Canva ---
    (function(){
      const overlay = document.getElementById('canva-overlay');
      const openBtn = document.getElementById('btn-open');
      const controls = document.getElementById('canva-controls');
      const closeBtn = document.getElementById('btn-close');
      const btnSmall = document.getElementById('ctrl-small');
      const btnQuarter = document.getElementById('ctrl-quarter');
      const btnFull = document.getElementById('ctrl-full');
      const btnReset = document.getElementById('ctrl-reset');

      const setMode = (mode) => {
        overlay.dataset.mode = mode;
        // valeurs par défaut (flottant bas-droite)
        overlay.style.top = 'auto';
        overlay.style.left = 'auto';
        overlay.style.bottom = '20px';
        overlay.style.right = '20px';
        overlay.style.borderRadius = '14px';
        overlay.style.pointerEvents = 'auto';

        if (mode === 'small') {
          overlay.style.width = '320px';
          overlay.style.height = '180px'; // ~16:9
        } else if (mode === 'quarter') {
          // Plus grand qu'avant comme demandé
          overlay.style.width = '45vw';
          overlay.style.height = '45vh';
        } else if (mode === 'full') {
          overlay.style.top = '0';
          overlay.style.left = '0';
          overlay.style.bottom = 'auto';
          overlay.style.right = 'auto';
          overlay.style.width = '100vw';
          overlay.style.height = '100vh';
          overlay.style.borderRadius = '0';
        }
      };

      const showControls = (show) => {
        openBtn.style.display = show ? 'none' : 'inline-block';
        controls.style.display = show ? 'flex' : 'none';
      };

      openBtn.addEventListener('click', () => {
        overlay.style.display = 'block';
        setMode('small');
        showControls(true);
      });

      btnSmall.addEventListener('click', () => setMode('small'));
      btnQuarter.addEventListener('click', () => setMode('quarter'));
      btnFull.addEventListener('click', () => setMode('full'));

      // Fermer l'overlay (sans reset de la toolbar globale)
      closeBtn.addEventListener('click', () => {
        overlay.style.display = 'none';
      });

      // Revenir à l'état de base: cache l'overlay ET ré-affiche seulement "GUIDE CANVA"
      btnReset.addEventListener('click', () => {
        overlay.style.display = 'none';
        showControls(false);
      });

      // Échap ferme l'overlay (sans reset)
      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') overlay.style.display = 'none';
      });

      // Déplaçable (sauf plein écran)
      let dragging = false, startX=0, startY=0, originX=0, originY=0;
      overlay.addEventListener('pointerdown', (e) => {
        if (overlay.dataset.mode === 'full') return; // pas de drag en plein écran
        dragging = true; overlay.setPointerCapture(e.pointerId);
        startX = e.clientX; startY = e.clientY;
        originX = overlay.offsetLeft; originY = overlay.offsetTop;
      });
      overlay.addEventListener('pointermove', (e) => {
        if (!dragging) return;
        const dx = e.clientX - startX; const dy = e.clientY - startY;
        overlay.style.left = (originX + dx) + 'px';
        overlay.style.top = (originY + dy) + 'px';
        overlay.style.right = 'auto'; overlay.style.bottom = 'auto';
      });
      overlay.addEventListener('pointerup', () => dragging = false);
      overlay.addEventListener('pointercancel', () => dragging = false);
    })();
  </script>
</body>
</html>
